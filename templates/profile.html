{% extends "base.html" %}
{% block content %}
<div class="card">
  <div class="profile-header">
    <h2 class="profile-title">üë§ Player Profile</h2>
  </div>
</div>

<div class="card">
  <div class="profile-main">
    <div class="profile-avatar-section">
      {% if user.profile_image_data %}
        <!-- New base64 image system -->
        {% if user.profile_image_mime_type == 'video/mp4' %}
          <video controls autoplay muted loop
                 class="profile-media">
            <source src="{{ user.profile_image_data }}" type="video/mp4">
          </video>
        {% else %}
          <img src="{{ user.profile_image_data }}" alt="Profile"
               class="profile-media">
        {% endif %}
      {% elif user.profile_image_url %}
        <!-- Legacy file-based system (backward compatibility) -->
        {% if user.profile_image_url.endswith('.mp4') %}
          <video controls autoplay muted loop src="{{ user.profile_image_url }}"
                 class="profile-media">
          </video>
        {% else %}
          <img src="{{ user.profile_image_url }}" alt="Profile"
               class="profile-media">
        {% endif %}
      {% else %}
        <!-- Default avatar -->
        <div class="profile-default-avatar">
          üë§
        </div>
      {% endif %}
      
      <h3 class="profile-name">{{ user.display_name or user.username }}</h3>
      
      {% if user.username != (user.display_name or user.username) %}
        <p class="profile-username">@{{ user.username }}</p>
      {% endif %}
      
      <div class="profile-stats-section">
        <div class="profile-credits-box">
          <strong class="profile-credits-value">{{ user.mini_word_credits or 0 }}</strong>
          <div class="profile-credits-label">Credits</div>
        </div>
        
        <!-- Profile buttons: Show for profile owner with both server-side and client-side checks -->
        <div class="profile-buttons"
             {% if session.get('user_id') == user.id or session.get('user_id') == user.id|string %}
             style="display: block;"
             {% else %}
             style="display: none;"
             {% endif %}
             data-profile-owner="{{ user.id }}"
             data-requires-owner="true">
          <button class="btn profile-button" data-action="show-change-name">
            ‚úèÔ∏è Change Name
          </button>
          <button class="btn profile-button" data-action="show-image-upload">
            üé¨ Change Image/Media
          </button>
          <button class="btn profile-button" data-action="show-change-password">
            üîí Change Password
          </button>
          <div class="profile-button-info">
            Supports: PNG, JPG, JPEG, GIF, WebP, MP4<br>
            Max: 10MB ‚Ä¢ Videos: 11 seconds max
          </div>
        </div>
      </div>
    </div>
    
    <div class="profile-game-stats">
      <h3 class="profile-stats-title">üèÜ Game Statistics</h3>
      
      {% if best_scores %}
        <div class="profile-scores-grid">
          {% for score in best_scores %}
          <div class="profile-score-card">
            <h4 class="profile-score-mode">{{ score.mode or 'Unknown' }}</h4>
            <div class="profile-score-value">{{ score.best_points or 0 }}</div>
            <div class="profile-score-label">Best Score</div>
            <div class="profile-score-games">{{ score.games_count or 0 }} games played</div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="profile-no-games">
          <p class="profile-no-games-text">No games played yet</p>
        </div>
      {% endif %}
      
      <h3 class="profile-recent-title">üìä Recent Games</h3>
      
      {% if recent_scores %}
        <div class="profile-table-wrapper">
          <table class="profile-table">
            <thead>
              <tr class="profile-table-header">
                <th class="profile-table-th">Mode</th>
                <th class="profile-table-th profile-table-th-right">Score</th>
                <th class="profile-table-th profile-table-th-right">Words</th>
                <th class="profile-table-th profile-table-th-right">Time</th>
                <th class="profile-table-th">When</th>
              </tr>
            </thead>
            <tbody>
              {% for score in recent_scores %}
              <tr class="profile-table-row">
                <td class="profile-table-td">{{ score.game_mode }}</td>
                <td class="profile-table-td profile-table-td-right">{{ score.points }}</td>
                <td class="profile-table-td profile-table-td-right">{{ score.words_found }}</td>
                <td style="padding:8px;text-align:right;">
                  {% if score.time_ms %}
                    {{ "%.1f"|format(score.time_ms/1000) }}s
                  {% else %}
                    -
                  {% endif %}
                </td>
                <td style="padding:8px;font-size:12px;opacity:0.7;">
                  {{ score.played_at.strftime('%m/%d %H:%M') }}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center;">
          <p style="margin:0;opacity:0.7;">No recent games</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% if session.get('user_id') == user.id or session.get('user_id') == user.id|string %}
<!-- Change Name Form (hidden by default) -->
<div id="changeNameForm" class="card profile-form">
  <h3 class="profile-form-title">Change Display Name</h3>
  <form id="nameForm">
    <input type="text" id="newName" placeholder="Enter new display name"
           value="{{ user.display_name or user.username }}"
           class="profile-input">
    <div class="profile-form-buttons">
      <button type="submit" class="btn">Save Changes</button>
      <button type="button" class="btn btn-secondary" data-cancel="name-form">Cancel</button>
    </div>
  </form>
  <div id="cooldownMessage" class="profile-cooldown-msg"></div>
  <div class="profile-form-info">
    Free ‚Ä¢ 24-hour cooldown between changes
  </div>
</div>

<!-- Image Upload Form (hidden by default) -->
<div id="imageUploadForm" class="card profile-form">
  <h3 class="profile-form-title">Change Profile Media</h3>
  <form id="imageForm">
    <input type="file" id="imageFile" accept="image/*,video/mp4"
           class="profile-input">
    <div class="profile-form-buttons">
      <button type="submit" class="btn">Upload Media</button>
      <button type="button" class="btn btn-secondary" data-cancel="image-form">Cancel</button>
    </div>
  </form>
  <div class="profile-form-info">
    Free ‚Ä¢ Max 10MB, PNG/JPG/JPEG/GIF/WebP/MP4 (max 11s) ‚Ä¢ 24-hour cooldown
  </div>
</div>

<!-- Change Password Form (hidden by default) -->
<div id="changePasswordForm" class="card profile-form">
  <h3 class="profile-form-title">Change Password</h3>
  <form id="passwordForm">
    <div class="password-field">
      <input type="password" id="currentPassword" placeholder="Current password"
             class="profile-input" autocomplete="current-password">
      <button type="button" class="password-toggle" aria-label="Show current password" aria-pressed="false">
        <span class="show-text" aria-hidden="true">üëÅÔ∏è</span>
        <span class="hide-text" aria-hidden="true">üôà</span>
      </button>
    </div>

    <div class="password-field">
      <input type="password" id="newPassword" placeholder="New password"
             class="profile-input" autocomplete="new-password">
      <button type="button" class="password-toggle" aria-label="Show new password" aria-pressed="false">
        <span class="show-text" aria-hidden="true">üëÅÔ∏è</span>
        <span class="hide-text" aria-hidden="true">üôà</span>
      </button>
    </div>

    <div class="password-field">
      <input type="password" id="confirmPassword" placeholder="Confirm new password"
             class="profile-input" autocomplete="new-password">
      <button type="button" class="password-toggle" aria-label="Show confirm password" aria-pressed="false">
        <span class="show-text" aria-hidden="true">üëÅÔ∏è</span>
        <span class="hide-text" aria-hidden="true">üôà</span>
      </button>
    </div>

    <div class="profile-form-buttons">
      <button type="submit" class="btn">Update Password</button>
      <button type="button" class="btn btn-secondary" data-cancel="password-form">Cancel</button>
    </div>
  </form>
  <div class="profile-form-info">
    Enter your current password and choose a new one
  </div>
</div>

<!-- New This Week Section -->
<div class="card">
  <div class="profile-header">
    <h3 style="color: var(--accent, #4aa8ff); margin: 0 0 15px;">‚ú® New This Week</h3>
  </div>

  <div style="display: flex; flex-direction: column; gap: 15px;">
    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <span style="font-size: 1.5em; min-width: 40px; text-align: center;">‚ùå‚≠ï</span>
      <div style="flex: 1;">
        <strong style="color: var(--accent, #4aa8ff); display: block; margin-bottom: 4px;">Tic-Tac-Toe Game</strong>
        <p style="margin: 0; color: var(--muted, #9fb0c3); font-size: 0.9em;">Challenge yourself vs CPU or play with friends locally!</p>
      </div>
    </div>

    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <span style="font-size: 1.5em; min-width: 40px; text-align: center;">üü°üî¥</span>
      <div style="flex: 1;">
        <strong style="color: var(--accent, #4aa8ff); display: block; margin-bottom: 4px;">Connect 4 Game</strong>
        <p style="margin: 0; color: var(--muted, #9fb0c3); font-size: 0.9em;">Drop discs and connect four in a row to win!</p>
      </div>
    </div>

    <div style="display: flex; align-items: center; gap: 15px; padding: 12px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
      <span style="font-size: 1.5em; min-width: 40px; text-align: center;">üß©</span>
      <div style="flex: 1;">
        <strong style="color: var(--accent, #4aa8ff); display: block; margin-bottom: 4px;">Enhanced Riddle System</strong>
        <p style="margin: 0; color: var(--muted, #9fb0c3); font-size: 0.9em;">Improved difficulty modes and daily free games reset at 12 EST</p>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/password-toggle.js') }}"></script>
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>

<script>
// Profile ownership verification for mobile/desktop consistency
document.addEventListener('DOMContentLoaded', async function() {
  const profileButtons = document.querySelector('[data-requires-owner="true"]');
  if (!profileButtons) {
    console.log('Profile: No profile buttons found with data-requires-owner="true"');
    return;
  }

  const profileOwnerId = profileButtons.dataset.profileOwner;
  console.log('Profile: Profile owner ID from dataset:', profileOwnerId);
  console.log('Profile: Initial button display style:', profileButtons.style.display);

  try {
    // Get current user from backend
    const response = await fetch('/__diag/whoami', { credentials: 'include' });
    const data = await response.json();

    console.log('Profile: Whoami response:', data);

    if (data.authenticated && data.user_id) {
      const currentUserId = data.user_id.toString();
      console.log('Profile: Current user ID:', currentUserId, 'Profile owner ID:', profileOwnerId);

      if (currentUserId === profileOwnerId) {
        // User is the profile owner - ensure buttons are visible
        profileButtons.style.display = 'block';
        console.log('Profile: ‚úÖ Confirmed profile owner, showing buttons');
      } else {
        // User is not the profile owner - hide buttons
        profileButtons.style.display = 'none';
        console.log('Profile: ‚ùå Not profile owner, hiding buttons');
      }
    } else {
      // User is not authenticated - hide buttons
      profileButtons.style.display = 'none';
      console.log('Profile: ‚ùå User not authenticated, hiding buttons');
    }
  } catch (error) {
    console.warn('Profile: Error checking profile ownership:', error);
    console.log('Profile: Using server-side state, current display:', profileButtons.style.display);
    // Fallback: trust server-side rendering
  }
});
</script>
{% endif %}
{% endblock %}