{% extends "base.html" %}
{% block content %}

<div class="card game-card-margin">
  <div class="game-header">
    <div class="mode-badge">Mode: {{ mode|capitalize }}</div>
    <div class="game-nav-buttons">
      <span class="game-seed-badge">Seed: {{ seed }}</span>
      <a class="btn" href="{{ url_for('home') }}">Modes</a>
      <a class="btn" href="{{ url_for('leaderboard') }}">All-Time</a>
      <a class="btn" href="{{ url_for('daily_leaderboard') }}">Daily</a>
      <a class="btn" href="{{ url_for('logout') }}">Logout</a>
    </div>
  </div>
</div>

<div class="card">
  <div class="game-main">
    <div class="game-grid-container">
      <table aria-label="word grid">
        {% for row in grid %}
          <tr>
            {% for cell in row %}
              <td class="game-cell">
                {{ cell }}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </table>
    </div>

    <div class="game-sidebar">
      <h3 class="game-words-title">Find these words</h3>
      <ul class="game-words-list">
        {% for w in words %}<li class="game-word-item">{{ w }}</li>{% endfor %}
      </ul>

      {% if seconds > 0 %}
        <div class="game-timer-section">
          <span class="mode-badge game-timer-badge">
            Time left: <span id="tleft">{{ seconds }}</span>s
          </span>
        </div>
      {% else %}
        <div class="game-timer-section">
          <span class="mode-badge game-no-timer-badge">No timer (Easy)</span>
        </div>
      {% endif %}

      <div class="game-actions">
        <a class="btn" href="{{ url_for('play', mode=mode) }}">New Random</a>
        <a class="btn" href="{{ url_for('daily', mode=mode) }}">Daily</a>
        <a class="btn" href="{{ url_for('seed_play', mode=mode, seed=seed) }}">Replay</a>
      </div>

      <form id="scoreForm" method="post" action="{{ url_for('submit_score') }}" class="game-score-form">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" id="elapsed" name="elapsed" value="0">
        <input type="hidden" id="score" name="score" value="0">
        <input type="hidden" name="seed" value="{{ seed }}">
        <input type="text" name="note" placeholder="Say something (community note)" maxlength="140" class="game-note-input">
        <button class="btn game-submit-btn" type="submit">Submit Score</button>
      </form>

      <div class="game-score-info">
        Score = words × 100 − elapsed seconds (timed modes only).
      </div>

      {% if not ad_free %}
      <div class="card game-ad-card">
        <!-- AdSense (loads only when you configure env vars) -->
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ adsense_client }}" crossorigin="anonymous"></script>
        <ins class="adsbygoogle" style="display:block"
             data-ad-client="{{ adsense_client }}"
             data-ad-slot="{{ adsense_slot }}"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>(adsbygoogle=window.adsbygoogle||[]).push({});</script>

        <form class="game-ad-form" method="post" action="{{ url_for('spend_credit') }}">
          <input type="hidden" name="action" value="ad_free_day">
          <button class="btn game-ad-btn" type="submit">Spend 1 credit for Ad-free Day (24h)</button>
        </form>
        <div class="game-credits-info">Credits: <strong>{{ credits or 0 }}</strong></div>
      </div>
      {% else %}
      <div class="success game-ad-free">
        Ad-free active until {{ ad_free_until_human }}
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
(function(){
  const seconds = {{ seconds|int }};
  const hasTimer = seconds > 0;
  const start = Date.now();
  const tleft = document.getElementById('tleft');
  const elapsedField = document.getElementById('elapsed');
  const scoreField = document.getElementById('score');

  function computeScore() {
    const elapsed = Math.floor((Date.now() - start) / 1000);
    elapsedField.value = elapsed;
    const wordsCount = {{ words|length }};
    let score = wordsCount * 100;
    if (hasTimer) score -= elapsed;
    if (score < 0) score = 0;
    scoreField.value = score;
  }

  if (hasTimer && tleft) {
    const tick = () => {
      const left = seconds - Math.floor((Date.now() - start)/1000);
      if (left <= 0) {
        tleft.textContent = 0;
        computeScore();
        document.getElementById('scoreForm').submit();
      } else {
        tleft.textContent = left;
        requestAnimationFrame(tick);
      }
    };
    requestAnimationFrame(tick);
  }

  document.getElementById('scoreForm').addEventListener('submit', computeScore);
})();
</script>

{% endblock %}