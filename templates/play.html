{% extends "base.html" %}
{% block head %}
<style>
/* Modern Game Counter Component */
.game-counter-card {
  width: 100%;
  max-width: none;
  margin: 10px 0;
  border-radius: 8px;
  background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
  color: white;
  padding: 12px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.counter-section {
  margin-bottom: 16px;
}

.counter-section:last-child {
  margin-bottom: 0;
}

.counter-header {
  display: flex;
  flex-direction: column;
  gap: 4px;
  margin-bottom: 8px;
}

.counter-title {
  font-size: 16px;
  font-weight: 600;
  color: #ffffff;
}

.counter-usage {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  text-align: right;
  align-self: flex-end;
}

.progress-bar {
  width: 100%;
  height: 8px;
  background: #334155;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 6px;
  transition: width 0.3s ease;
  position: relative;
}

.progress-fill.full {
  background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%);
}

.credits-section {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(51, 65, 85, 0.5);
  border-radius: 8px;
  padding: 12px;
}

.credits-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 500;
  font-size: 14px;
}

.credits-icon {
  width: 18px;
  height: 18px;
  color: #fbbf24;
}

.credits-amount {
  font-size: 16px;
  font-weight: 700;
  color: #ffffff;
}

.play-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

/* Legacy stats fallback */
.play-stats {
  margin-top: 10px;
  text-align: center;
  font-size: 14px;
  color: var(--muted, #9fb0c3);
}

.stat-item {
  color: var(--text, #ffffff);
}

.stat-separator {
  margin: 0 8px;
  color: var(--muted, #9fb0c3);
}
</style>
<script>
// Animate progress bar on load
document.addEventListener('DOMContentLoaded', function() {
  const progressFill = document.getElementById('progress-bar-fill');
  if (progressFill) {
    const percentage = progressFill.getAttribute('data-percentage');
    // Animate the progress bar after a short delay
    setTimeout(() => {
      progressFill.style.width = percentage + '%';
    }, 100);
  }
});

// Debug function to reset game counter
window.resetGameCounter = async function() {
  try {
    const response = await fetch('/api/debug/reset-game-counter', {
      method: 'POST',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
        'Content-Type': 'application/json'
      },
      credentials: 'include'
    });
    const result = await response.json();
    console.log('Counter reset result:', result);
    if (result.ok) {
      alert('Game counter reset! Refresh the page to see 0/5.');
      location.reload();
    } else {
      alert('Failed to reset counter: ' + (result.error || 'Unknown error'));
    }
  } catch (error) {
    console.error('Error resetting counter:', error);
    alert('Error resetting counter. Check console for details.');
  }
};
</script>
{% endblock %}

{% block content %}
<h2 class="play-title">{{ 'Daily ' if daily else '' }}{{ mode|capitalize }} â€” Word Search</h2>
{% if category %}<div class="play-theme">
  Theme: <strong>{{ category.replace('_',' ').title() }}</strong>
</div>{% endif %}

<div id="meta"
     data-mode="{{mode}}"
     data-daily="{{1 if daily else 0}}"
     data-category="{{category or ''}}"
     data-hints-max="{{ config.get('HINTS_PER_PUZZLE', 3) }}"
     data-puzzle-id="{{ puzzle.puzzle_id if puzzle else '' }}">
</div>

<div class="play-container">
  <div class="play-header">
    <div id="timer" class="play-timer" style="display: none;"></div>
  </div>

  <div class="play-game-card">
    <div class="play-game-content">
      <div id="grid" class="play-grid"></div>
      <div class="play-words-section">
        <h3>Find these words</h3>
        <div id="wordlist" class="play-word-list"></div>

        <button id="finishBtn" class="btn" style="margin-top: 10px;" disabled>Find All Words (0/5)</button>

        <!-- Modern Game Counter Component -->
        <div class="game-counter-card" style="margin: 20px 0;">
          <!-- Free Game Counter -->
          <div class="counter-section">
            <div class="counter-header">
              <h2 class="counter-title">Mini Word Finder</h2>
              <span class="counter-usage">{{ user_stats.free_games_used if user_stats else 0 }}/{{ user_stats.free_games_limit if user_stats else 5 }} Free Games Used</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill{% if user_stats and user_stats.free_games_used >= user_stats.free_games_limit %} full{% endif %}"
                   id="progress-bar-fill"
                   data-percentage="{{ ((user_stats.free_games_used / user_stats.free_games_limit * 100) | round) if user_stats else 0 }}"
                   style="width: 0%">
              </div>
            </div>
          </div>

          <!-- Credits Counter -->
          <div class="counter-section">
            <div class="credits-section">
              <div class="credits-label">
                <svg class="credits-icon" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1.5V6H9V1.5L3 7V9H1V11H3L4 22H20L21 11H23V9H21Z"/>
                </svg>
                <span>Credits</span>
              </div>
              <span class="credits-amount">{{ "{:,}".format(user_stats.credits) if user_stats else "0" }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="celebration" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
    <h2>ðŸŽ‰ Congratulations!</h2>
    <p>You found all the words!</p>
    <button onclick="document.getElementById('celebration').style.display='none'" class="btn">Close</button>
  </div>

  <div id="completionDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #663399, #9966cc); color: white; padding: 30px; border-radius: 16px; border: 3px solid white; box-shadow: 0 8px 32px rgba(0,0,0,0.4); text-align: center; max-width: 400px; margin: 20px;">
      <h2 style="margin: 0 0 10px 0; font-size: 24px;">ðŸŽ‰ Game Complete!</h2>
      <div id="completionStats" style="margin: 20px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
        <p style="margin: 5px 0; font-size: 16px;" id="wordsFoundText">All words found!</p>
        <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="timeCompletedText">Time: --:--</p>
        <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;" id="scoreText">Score saved!</p>
      </div>
      <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
        <button id="playAgainBtn" class="btn primary" style="flex: 1; min-width: 120px;">Play Next Game</button>
        <button id="backToMenuBtn" class="btn secondary" style="flex: 1; min-width: 120px;">Main Menu</button>
      </div>
    </div>
  </div>
</div>

<script src="{{ url_for('static', filename='js/play.js') }}?v={{ config.ASSET_VERSION }}"></script>
{% endblock %}