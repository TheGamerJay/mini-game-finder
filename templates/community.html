{% extends "base.html" %}

{% block head %}
<script src="{{ url_for('static', filename='js/community.js') }}?v=10"></script>
<style>
.new-this-week {
  background: linear-gradient(135deg, #1a2332 0%, #0f1520 100%);
  border: 2px solid var(--accent, #4aa8ff);
  margin-bottom: 25px;
}

.new-features {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 15px;
}

.feature-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.feature-icon {
  font-size: 1.5em;
  min-width: 40px;
  text-align: center;
}

.feature-text {
  flex: 1;
}

.feature-text strong {
  color: var(--accent, #4aa8ff);
  display: block;
  margin-bottom: 4px;
}

.feature-text p {
  margin: 0;
  color: var(--muted, #9fb0c3);
  font-size: 0.9em;
}

.reaction-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.reaction-btn {
  padding: 6px 8px;
  font-size: 1.2em;
  border-radius: 20px;
  transition: all 0.2s ease;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.reaction-btn:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

.reaction-btn.reaction-active {
  background: var(--accent, #4aa8ff);
  border-color: var(--accent, #4aa8ff);
  box-shadow: 0 0 10px rgba(74, 168, 255, 0.3);
}

.reaction-counts {
  font-size: 0.9em;
  color: var(--muted, #9fb0c3);
  margin-bottom: 10px;
}

.total-reactions {
  color: var(--accent, #4aa8ff);
  font-weight: bold;
}

.community-stats {
  background: linear-gradient(135deg, #2a3441 0%, #1f2937 100%);
  border: 1px solid rgba(74, 168, 255, 0.3);
  margin-bottom: 20px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.stat-item {
  text-align: center;
  padding: 12px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-value {
  display: block;
  font-size: 1.5em;
  font-weight: bold;
  color: var(--accent, #4aa8ff);
  margin-bottom: 4px;
}

.stat-label {
  font-size: 0.8em;
  color: var(--muted, #9fb0c3);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.btn-danger {
  background: rgba(239, 68, 68, 0.2);
  border: 1px solid rgba(239, 68, 68, 0.4);
  color: #ef4444;
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.3);
  border-color: #ef4444;
  transform: scale(1.05);
}

.post-selectors {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.selector-group {
  flex: 1;
  min-width: 150px;
}

.selector-group label {
  display: block;
  color: var(--muted, #9fb0c3);
  font-size: 0.9em;
  margin-bottom: 5px;
  font-weight: 500;
}

.form-select {
  width: 100%;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 6px;
  color: var(--text-primary, #fff);
  font-size: 0.9em;
  transition: all 0.2s ease;
}

.form-select:focus {
  background: rgba(255, 255, 255, 0.15);
  border-color: var(--accent, #4aa8ff);
  outline: none;
  box-shadow: 0 0 0 2px rgba(74, 168, 255, 0.2);
}

.form-select option {
  background: var(--bg-secondary, #1f2937);
  color: var(--text-primary, #fff);
}

@media (max-width: 768px) {
  .new-features {
    gap: 10px;
  }

  .feature-item {
    padding: 10px;
    gap: 10px;
  }

  .feature-icon {
    font-size: 1.2em;
    min-width: 30px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container">

    <div class="flex-between">
        <h1>üë• Community</h1>
        <div class="post-meta">
            Share your achievements and connect with other players
        </div>
    </div>

    {% if current_user and current_user.is_authenticated %}
    <!-- User Stats Display -->
    {% if user_summary %}
    <div class="card community-stats">
        <h3>üìä Your Community Activity</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-value">{{ user_summary.posts_today }}/10</span>
                <span class="stat-label">Posts today</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ user_summary.reactions_today }}/25</span>
                <span class="stat-label">Reactions today</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ user_summary.total_posts }}</span>
                <span class="stat-label">Total posts</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ user_summary.total_reactions_received }}</span>
                <span class="stat-label">Reactions received</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Post Composer -->
    <div class="card post-card">
        <h3>‚úçÔ∏è Share Something</h3>
        <form id="postForm" enctype="multipart/form-data" class="share-form">
            <!-- Category and Content Type Selectors -->
            <div class="post-selectors">
                <div class="selector-group">
                    <label for="categorySelect">Category:</label>
                    <select id="categorySelect" name="category" class="form-select">
                        {% for key, value in categories.items() %}
                        <option value="{{ key }}" {% if key == 'general' %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="selector-group">
                    <label for="contentTypeSelect">Type:</label>
                    <select id="contentTypeSelect" name="content_type" class="form-select">
                        {% for key, value in content_types.items() %}
                        <option value="{{ key }}" {% if key == 'general' %}selected{% endif %}>{{ value }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <textarea
                id="postBody"
                name="body"
                placeholder="What's on your mind? Share your latest puzzle victories, tips, or just say hello!"
                class="share-textarea"
                maxlength="500"
            ></textarea>

            <div class="share-controls">
                <button type="submit" class="btn">
                    üöÄ Post
                </button>
            </div>

            <div id="postCharCount" class="char-count">0/500</div>
            <div class="post-meta" style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                üïí 2-minute cooldown between posts ‚Ä¢ 10 posts per day limit
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Community Feed -->
    <div id="communityFeed">
        {% if posts %}
            {% for post in posts %}
            <div class="post-card card">
                <!-- Post Header -->
                <div class="post-header">
                    {% if post.user.profile_image_data %}
                        <!-- New base64 image system -->
                        {% if post.user.profile_image_mime_type == 'video/mp4' %}
                            <video controls autoplay muted loop class="user-avatar">
                                <source src="{{ post.user.profile_image_data }}" type="video/mp4">
                            </video>
                        {% else %}
                            <img src="{{ post.user.profile_image_data }}" class="user-avatar">
                        {% endif %}
                    {% elif post.user.profile_image_url %}
                        <!-- Legacy file-based system -->
                        {% if post.user.profile_image_url.endswith('.mp4') %}
                            <video controls autoplay muted loop src="{{ post.user.profile_image_url }}" class="user-avatar">
                            </video>
                        {% else %}
                            <img src="{{ post.user.profile_image_url }}" class="user-avatar">
                        {% endif %}
                    {% else %}
                        <!-- Default avatar -->
                        <div class="user-avatar">
                            {{ (post.user.display_name or post.user.username or 'U')[0].upper() }}
                        </div>
                    {% endif %}

                    <div class="post-meta">
                        <div>
                            {{ post.user.display_name or post.user.username or 'Anonymous' }}
                        </div>
                        <div>
                            {{ post.created_at.strftime('%b %d, %Y at %I:%M %p') }}
                        </div>
                    </div>

                    {% if current_user and current_user.is_authenticated %}
                    <!-- Delete Button (for own posts) -->
                    {% if post.user.id == current_user.id %}
                    <button data-action="delete-post" data-post-id="{{ post.id }}"
                            class="btn btn-danger"
                            title="Delete my post"
                            style="margin-right: 8px;">
                        üóëÔ∏è
                    </button>
                    {% endif %}

                    <!-- Report Button -->
                    <button data-action="report" data-post-id="{{ post.id }}"
                            class="btn"
                            title="Report post">
                        ‚ö†Ô∏è
                    </button>
                    {% endif %}
                </div>

                <!-- Post Content -->
                {% if post.body %}
                <div class="post-content">
                    {{ post.body }}
                </div>
                {% endif %}

                <!-- Post Image -->
                {% if post.image_url %}
                <div>
                    <img src="{{ post.image_url }}"
                         class="post-image"
                         data-action="open-modal" data-image-url="{{ post.image_url }}"
                         loading="lazy">
                </div>
                {% endif %}

                <!-- Post Actions -->
                {% if current_user and current_user.is_authenticated %}
                <div class="post-actions">
                    <!-- Multi-Reaction Buttons -->
                    <div class="reaction-buttons">
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="love"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'love' else '' }}"
                                title="Love - Shows love and appreciation">
                            ‚ù§Ô∏è
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="magic"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'magic' else '' }}"
                                title="Magic - This feels magical or inspiring">
                            ‚ú®
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="peace"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'peace' else '' }}"
                                title="Peace - This brings me peace">
                            üåø
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="fire"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'fire' else '' }}"
                                title="Fire - This is amazing/powerful">
                            üî•
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="gratitude"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'gratitude' else '' }}"
                                title="Gratitude - Thank you for sharing">
                            üôè
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="star"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'star' else '' }}"
                                title="Star - This brightened my day">
                            ‚≠ê
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="applause"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'applause' else '' }}"
                                title="Applause - Well said!">
                            üëè
                        </button>
                        <button data-action="toggle-reaction" data-post-id="{{ post.id }}" data-reaction="support"
                                class="reaction-btn btn {{ 'reaction-active' if user_reactions.get(post.id) == 'support' else '' }}"
                                title="Support - Sending support and care">
                            ü´∂
                        </button>
                    </div>

                    <!-- Reaction Counts Display -->
                    <div class="reaction-counts">
                        Total reactions: <span class="total-reactions">{{ r_counts.get(post.id, 0) }}</span>
                    </div>

                    <!-- Promote Post Button -->
                    <button data-action="boost" data-post-id="{{ post.id }}"
                            class="boost-btn btn"
                            data-post-id="{{ post.id }}"
                            title="Spend 10 credits to promote this post higher in the community feed">
                        <span>üöÄ</span>
                        <span>Promote Post (10 credits)</span>
                    </button>

                    <!-- Promotion War Challenge Button -->
                    <button data-action="challenge-war" data-post-id="{{ post.id }}" data-user-id="{{ post.user.id }}"
                            class="war-btn btn"
                            data-post-id="{{ post.id }}"
                            title="Challenge this user to a 1-hour promotion war! Winner gets benefits, loser gets penalties."
                            {% if post.user.id == current_user.id %}disabled{% endif %}>
                        <span>‚öîÔ∏è</span>
                        <span>Promotion War</span>
                    </button>
                </div>

                <!-- Boost Score Display -->
                {% if post.boost_score and post.boost_score > 0 %}
                <div class="post-meta">
                    <span>üöÄ</span>
                    <span>{{ post.boost_score }} promotion level</span>
                    {% if post.last_boost_at %}
                    <span>
                        (last boosted {{ post.last_boost_at.strftime('%H:%M') }})
                    </span>
                    {% endif %}
                </div>
                {% endif %}

                {% else %}
                <div class="post-actions">
                    <div class="reaction-counts">
                        Total reactions: {{ r_counts.get(post.id, 0) }}
                    </div>
                    {% if post.boost_score and post.boost_score > 0 %}
                    <div class="boost-display">
                        üöÄ {{ post.boost_score }} promotion level
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}

            <!-- Pagination -->
            {% if has_more %}
            <div class="post-actions">
                <a href="/community?page={{ page + 1 }}" class="btn">Load More Posts</a>
            </div>
            {% endif %}
        {% else %}
            <div class="card post-card">
                <div>üåü</div>
                <h3>Welcome to the Community!</h3>
                <p class="post-meta">
                    No posts yet. Be the first to share something amazing!
                </p>
                {% if not current_user or not current_user.is_authenticated %}
                <a href="{{ url_for('core.login') }}" class="btn">
                    Join the Community
                </a>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="modal-overlay">
    <div class="modal-content">
        <img id="modalImage" class="modal-image">
    </div>
    <button data-action="close-modal" class="modal-close">√ó</button>
</div>

{% endblock %}