{% extends "base.html" %}

{% block head %}
<style>
.timezone-settings {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
}

.timezone-input {
    width: 100%;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary, #fff);
    font-size: 16px;
}

.timezone-suggestions {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: var(--bg-secondary, #1f2937);
    margin-top: 5px;
    display: none;
}

.timezone-suggestion {
    padding: 10px 12px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.timezone-suggestion:hover {
    background: rgba(255, 255, 255, 0.1);
}

.current-timezone {
    background: rgba(74, 168, 255, 0.1);
    border: 1px solid rgba(74, 168, 255, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.timezone-examples {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    font-size: 14px;
    color: var(--muted, #9fb0c3);
}

.btn-clear {
    background: rgba(239, 68, 68, 0.2);
    border: 1px solid rgba(239, 68, 68, 0.4);
    color: #ef4444;
    margin-left: 10px;
}

.btn-clear:hover {
    background: rgba(239, 68, 68, 0.3);
}
</style>
{% endblock %}

{% block content %}
<div class="container timezone-settings">
    <h1>üåç Timezone Settings</h1>
    <p class="post-meta">Set your timezone for personalized daily limit resets</p>

    {% if current_timezone %}
    <div class="current-timezone">
        <h3>Current Timezone</h3>
        <p><strong>{{ current_timezone }}</strong></p>
        <p class="post-meta" id="nextReset">Calculating next reset...</p>
    </div>
    {% endif %}

    <div class="card">
        <h3>Update Timezone</h3>
        <form id="timezoneForm">
            <div style="margin-bottom: 15px;">
                <label for="timezoneInput">Timezone:</label>
                <input type="text"
                       id="timezoneInput"
                       class="timezone-input"
                       placeholder="Enter timezone (e.g., America/New_York, Eastern, UTC)"
                       value="{{ current_timezone or '' }}">
                <div id="timezoneSuggestions" class="timezone-suggestions"></div>
            </div>

            <div class="share-controls">
                <button type="submit" class="btn">
                    üíæ Save Timezone
                </button>
                {% if current_timezone %}
                <button type="button" id="clearTimezone" class="btn btn-clear">
                    üóëÔ∏è Clear (Use UTC)
                </button>
                {% endif %}
            </div>
        </form>

        <div class="timezone-examples">
            <h4>Common Timezones:</h4>
            <ul>
                <li><strong>Eastern:</strong> America/New_York</li>
                <li><strong>Central:</strong> America/Chicago</li>
                <li><strong>Mountain:</strong> America/Denver</li>
                <li><strong>Pacific:</strong> America/Los_Angeles</li>
                <li><strong>London:</strong> Europe/London</li>
                <li><strong>Paris:</strong> Europe/Paris</li>
                <li><strong>Tokyo:</strong> Asia/Tokyo</li>
                <li><strong>Sydney:</strong> Australia/Sydney</li>
            </ul>
            <p><strong>Or type common names:</strong> eastern, pacific, london, tokyo, etc.</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('timezoneForm');
    const input = document.getElementById('timezoneInput');
    const suggestions = document.getElementById('timezoneSuggestions');
    const clearBtn = document.getElementById('clearTimezone');

    // Auto-detect timezone on page load
    if (!input.value) {
        const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
        if (detectedTz) {
            fetch('/api/timezone/detect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timezone: detectedTz })
            });
        }
    }

    // Load next reset time
    loadNextResetTime();

    // Timezone search
    let searchTimeout;
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();

        if (query.length < 2) {
            suggestions.style.display = 'none';
            return;
        }

        searchTimeout = setTimeout(() => {
            fetch(`/api/timezones/search?q=${encodeURIComponent(query)}`)
                .then(r => r.json())
                .then(data => {
                    suggestions.innerHTML = '';
                    if (data.results && data.results.length > 0) {
                        data.results.forEach(result => {
                            const div = document.createElement('div');
                            div.className = 'timezone-suggestion';
                            div.textContent = result.label;
                            div.onclick = () => {
                                input.value = result.value;
                                suggestions.style.display = 'none';
                            };
                            suggestions.appendChild(div);
                        });
                        suggestions.style.display = 'block';
                    } else {
                        suggestions.style.display = 'none';
                    }
                });
        }, 300);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
            suggestions.style.display = 'none';
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const timezone = input.value.trim();

        fetch('/api/user/timezone', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ timezone })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Error: ' + data.error);
                if (data.suggestions) {
                    console.log('Suggestions:', data.suggestions);
                }
            }
        })
        .catch(err => {
            alert('Error updating timezone: ' + err.message);
        });
    });

    // Clear timezone
    if (clearBtn) {
        clearBtn.addEventListener('click', function() {
            if (confirm('Clear your timezone setting? Daily limits will reset at midnight UTC.')) {
                fetch('/api/user/timezone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timezone: '' })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                });
            }
        });
    }

    function loadNextResetTime() {
        const resetEl = document.getElementById('nextReset');
        if (!resetEl) return;

        fetch('/api/user/timezone')
            .then(r => r.json())
            .then(data => {
                if (data.next_reset) {
                    resetEl.textContent = `Daily limits reset in ${data.next_reset.formatted}`;
                } else {
                    resetEl.textContent = 'Daily limits reset at midnight UTC';
                }
            })
            .catch(() => {
                resetEl.textContent = 'Unable to calculate reset time';
            });
    }
});
</script>
{% endblock %}