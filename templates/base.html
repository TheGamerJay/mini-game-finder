<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mini Word Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" sizes="32x32" href="/static/images/TheLogo.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/images/TheLogo.png">
  <link rel="apple-touch-icon" href="/static/images/TheLogo.png">
  <link rel="shortcut icon" href="/static/images/TheLogo.png">
  <style>
    body{background:black;color:#e5e7eb;font-family:Inter,system-ui,Arial,sans-serif;margin:0}
    a{color:#93c5fd;text-decoration:none} a:hover{text-decoration:underline}
    .container{max-width:1000px;margin:0 auto;padding:16px}
    .nav{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937;background:linear-gradient(135deg, #663399, #9966cc)}
    .btn{background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .card{background:#111827;border:1px solid #1f2937;border-radius:14px;padding:12px}
    .input{background:#0b1220;color:#e5e7eb;border:1px solid #243244;border-radius:10px;padding:8px 10px;outline:none}
    ul{margin:0;padding-left:18px}
    code{background:#0b1220;padding:2px 6px;border-radius:6px;border:1px solid #243244}
    .alert{color:#f87171;background:#1f2937;padding:8px 12px;border-radius:8px;margin:8px 0}
    .success{color:#4ade80;background:#1f2937;padding:8px 12px;border-radius:8px;margin:8px 0}
  </style>
</head>
<body>
  <div class="nav">
    <a href="/" style="font-weight:700; color: white; text-decoration: none;">Mini Word Finder</a>
    <span style="flex:1"></span>
    {% if current_user and current_user.is_authenticated %}
      <a href="/store" class="btn" style="background: rgba(255,255,255,0.1); text-decoration: none;">ðŸ’Ž Store</a>
      <a href="/profile" class="btn" style="background: rgba(255,255,255,0.1); text-decoration: none;">ðŸ§‘ Profile</a>
      <a href="/community" class="btn" style="background: rgba(255,255,255,0.1); text-decoration: none;">ðŸ‘¥ Community</a>
      <a href="/wallet" class="btn" style="background: rgba(255,255,255,0.1); text-decoration: none;">ðŸ’° Wallet: {{ current_user.mini_word_credits }} credits</a>
      <a href="/logout" class="btn" style="background:#374151">Logout</a>
    {% elif session.get('user_id') %}
      <a href="/logout" class="btn" style="background:#374151">Logout</a>
    {% endif %}
  </div>
  <div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="{% if category == 'error' %}alert{% else %}success{% endif %}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </div>

  <!-- Footer with Terms and Privacy links -->
  <footer style="border-top: 1px solid #1f2937; padding: 20px 16px; text-align: center; color: rgba(229, 231, 235, 0.6); font-size: 0.85rem;">
    <div style="max-width: 1000px; margin: 0 auto; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <a href="/terms" style="color: #93c5fd; text-decoration: none;">Terms of Service</a>
      <span style="color: rgba(229, 231, 235, 0.3);">|</span>
      <a href="/privacy" style="color: #93c5fd; text-decoration: none;">Privacy Policy</a>
      <span style="color: rgba(229, 231, 235, 0.3);">|</span>
      <span>Â© 2025 Mini Word Finder</span>
    </div>
  </footer>

  {% if current_user and current_user.is_authenticated %}
  <script>
    // Auto-logout disabled to prevent session issues

    // Session timeout (30 minutes of inactivity)
    let sessionTimeout;
    let warningTimeout;
    const TIMEOUT_DURATION = 30 * 60 * 1000; // 30 minutes
    const WARNING_TIME = 25 * 60 * 1000; // Show warning at 25 minutes

    function resetSessionTimeout() {
      clearTimeout(sessionTimeout);
      clearTimeout(warningTimeout);

      // Show warning at 25 minutes
      warningTimeout = setTimeout(() => {
        if (confirm('Your session will expire in 5 minutes due to inactivity. Click OK to stay logged in.')) {
          resetSessionTimeout();
        }
      }, WARNING_TIME);

      // Auto logout at 30 minutes
      sessionTimeout = setTimeout(() => {
        alert('Your session has expired due to inactivity. You will be redirected to the login page.');
        window.location.href = '/logout';
      }, TIMEOUT_DURATION);
    }

    // Reset timeout on user activity
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
      document.addEventListener(event, resetSessionTimeout, true);
    });

    // Initialize session timeout
    resetSessionTimeout();
  </script>
  {% endif %}

  <!-- Auto-Logout on Exit Code -->
  {% if session.get('user_id') %}
  <script>
    let sessionCleared = false;
    let navigatingInternally = false;

    // Track internal navigation (same origin links)
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (link && link.href) {
        const linkUrl = new URL(link.href);
        if (linkUrl.origin === window.location.origin) {
          navigatingInternally = true;
          console.log('ðŸ”„ SECURITY: Internal navigation detected:', linkUrl.pathname);
          // Reset after a longer delay to allow navigation
          setTimeout(() => { navigatingInternally = false; }, 3000);
        }
      }
    });

    // Track form submissions (internal)
    document.addEventListener('submit', function(e) {
      navigatingInternally = true;
      console.log('ðŸ”„ SECURITY: Form submission detected (internal)');
      setTimeout(() => { navigatingInternally = false; }, 1000);
    });

    function clearSession() {
      // Only clear session if not navigating internally within the app
      if (!sessionCleared && !navigatingInternally) {
        sessionCleared = true;
        console.log('ðŸ”’ SECURITY: Clearing session due to external navigation/page close');
        fetch('/api/clear-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          keepalive: true // Ensures request completes even if page is closing
        }).catch(e => console.log('Session clear request sent'));
      } else if (navigatingInternally) {
        console.log('ðŸ”„ SECURITY: Keeping session for internal navigation');
      }
    }

    // Event listeners for session clearing
    window.addEventListener('beforeunload', clearSession);
    window.addEventListener('pagehide', clearSession);
    // Note: Removed blur and visibilitychange as they were too aggressive
    // Only use beforeunload and pagehide for more reliable detection
  </script>
  {% endif %}
</body>
</html>