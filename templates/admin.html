{% extends "base.html" %}

{% block head %}
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="back-nav">
        <a href="{{ url_for('home') }}" class="btn back-btn">
            ← Back to Home
        </a>
    </div>
    
    <h1>Admin Panel</h1>
    
    <div class="admin-section">
        <h2>Recent Purchases</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Credits</th>
                    <th>Amount</th>
                    <th>When</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for purchase in purchases %}
                <tr>
                    <td>{{ purchase.id }}</td>
                    <td>{{ purchase.user_id }}</td>
                    <td>{{ purchase.provider }}</td>
                    <td>
                        <span class="status-badge status-{{ purchase.status }}">{{ purchase.status }}</span>
                    </td>
                    <td>{{ purchase.credits }}</td>
                    <td>${{ '%.2f'|format((purchase.amount_usd_cents or 0)/100) }}</td>
                    <td class="muted">{{ purchase.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
                    <td>
                        <div class="admin-actions">
                            <button class="btn btn-sm" data-action="refund" data-purchase-id="{{ purchase.id }}" data-credits="{{ purchase.credits }}">Refund</button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="no-data">No purchases found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="admin-section">
        <h2>Recent Users</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Credits</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.mini_word_credits or 0 }}</td>
                    <td class="muted">{{ user.created_at.strftime("%Y-%m-%d") }}</td>
                    <td>
                        <div class="admin-actions">
                            <button class="btn btn-sm" data-action="adjust" data-user-id="{{ user.id }}">Adjust</button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">No users found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <div class="admin-section">
        <h2>Recent Credit Transactions</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>User</th>
                    <th>Amount</th>
                    <th>Reason</th>
                    <th>Balance After</th>
                    <th>When</th>
                </tr>
            </thead>
            <tbody>
                {% for txn in transactions %}
                <tr>
                    <td>{{ txn.id }}</td>
                    <td>{{ txn.user_id }}</td>
                    <td>
                        <span class="{{ 'positive' if txn.delta > 0 else 'negative' }}">
                            {{ '+' if txn.delta > 0 else '' }}{{ txn.delta }}
                        </span>
                    </td>
                    <td>{{ txn.reason }}</td>
                    <td>-</td>
                    <td class="muted">{{ txn.created_at.strftime("%Y-%m-%d %H:%M") }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="no-data">No transactions found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<style>
.btn {
    padding: 4px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background: #fff;
    cursor: pointer;
    font-size: 12px;
}

.btn:hover {
    background: #f9fafb;
}

.btn-sm {
    padding: 2px 6px;
    font-size: 11px;
}

.muted {
    color: #6b7280;
    font-size: 12px;
}

.row {
    display: flex;
    gap: 4px;
    align-items: center;
}

.status-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
}

.status-succeeded {
    background: #d1fae5;
    color: #065f46;
}

.status-created {
    background: #fef3c7;
    color: #92400e;
}

.status-failed {
    background: #fecaca;
    color: #991b1b;
}

.status-refunded {
    background: #e0e7ff;
    color: #3730a3;
}

.status-refunded_partial {
    background: #e0e7ff;
    color: #3730a3;
}
</style>

<script>
async function refundPurchase(id, maxCredits){
    const credits = prompt("Refund how many credits? (1–"+maxCredits+")\nNote: user must have at least this many unspent credits.");
    if(!credits) return;
    const note = prompt("Reason for refund (required):");
    if(!note) { alert("Refund requires a reason."); return; }
    
    const r = await fetch(`/admin/api/purchase/${id}/refund`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ credits: Number(credits), note })
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok){ 
        alert(j.error || 'Error'); 
        return; 
    }
    alert(j.message || 'Refund processed');
    location.reload();
}

async function adjustCredits(uid){
    const delta = prompt("Adjust credits (e.g., +10 or -5):");
    if(!delta) return;
    const note = prompt("Reason (required):");
    if(!note){ alert("Reason required."); return; }
    
    const r = await fetch(`/admin/api/user/${uid}/adjust-credits`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify({ delta: Number(delta), note })
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok){ 
        alert(j.error || 'Error'); 
        return; 
    }
    alert('Adjusted. New balance: '+j.credits);
    location.reload();
}
</script>
{% endblock %}