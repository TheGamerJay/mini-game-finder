{% extends "base.html" %}

{% block head %}
<style>
.admin-dashboard {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.health-metric {
    background: linear-gradient(135deg, #1a2332 0%, #0f1520 100%);
    border: 1px solid rgba(74, 168, 255, 0.3);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.metric-value {
    font-size: 2.5em;
    font-weight: bold;
    color: var(--accent, #4aa8ff);
    margin-bottom: 8px;
}

.metric-label {
    font-size: 0.9em;
    color: var(--muted, #9fb0c3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.metric-description {
    font-size: 0.8em;
    color: var(--muted, #9fb0c3);
    margin-top: 5px;
    opacity: 0.7;
}

.timezone-table, .distribution-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
}

.timezone-table th, .timezone-table td,
.distribution-table th, .distribution-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.timezone-table th, .distribution-table th {
    background: rgba(74, 168, 255, 0.2);
    color: var(--accent, #4aa8ff);
    font-weight: bold;
}

.percentage-high {
    color: #ef4444;
    font-weight: bold;
}

.percentage-medium {
    color: #f59e0b;
    font-weight: bold;
}

.percentage-low {
    color: #10b981;
    font-weight: bold;
}

.admin-actions {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.admin-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.admin-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

.admin-btn.danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.admin-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.test-section {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 12px;
    padding: 20px;
    margin-top: 30px;
}

.test-input {
    padding: 10px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary, #fff);
    margin-right: 10px;
    width: 120px;
}

.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 8px;
}

.status-online { background-color: #10b981; }
.status-warning { background-color: #f59e0b; }
.status-error { background-color: #ef4444; }

.refresh-time {
    text-align: center;
    color: var(--muted, #9fb0c3);
    font-size: 0.9em;
    margin-top: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="flex-between">
        <h1>üîß Community System Health</h1>
        <div class="refresh-time" id="refreshTime">
            Last updated: <span id="lastUpdate">Loading...</span>
        </div>
    </div>

    <!-- Admin Actions -->
    <div class="admin-actions">
        <button onclick="refreshStats()" class="admin-btn" id="refreshBtn">
            üìä Refresh Stats
        </button>
        <button onclick="vacuumTables()" class="admin-btn danger" id="vacuumBtn">
            üßπ Vacuum Tables
        </button>
        <button onclick="loadHealthData()" class="admin-btn">
            üîÑ Reload Dashboard
        </button>
    </div>

    <!-- System Health Overview -->
    <div class="card">
        <h3>üìä System Health Metrics</h3>
        <div class="health-grid" id="healthGrid">
            {% for metric in health_data %}
            <div class="health-metric">
                <div class="metric-value">{{ metric[1] }}</div>
                <div class="metric-label">{{ metric[0].replace('_', ' ').title() }}</div>
                <div class="metric-description">{{ metric[2] }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Capped Users by Timezone -->
    <div class="card">
        <h3>üåç Users at Daily Limit by Timezone</h3>
        <table class="timezone-table">
            <thead>
                <tr>
                    <th>Timezone</th>
                    <th>Capped Users</th>
                    <th>Total Users</th>
                    <th>Percentage</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for row in capped_users %}
                <tr>
                    <td>{{ row[0] or 'UTC' }}</td>
                    <td>{{ row[1] }}</td>
                    <td>{{ row[2] }}</td>
                    <td>
                        {% set percentage = row[3] or 0 %}
                        <span class="{% if percentage > 20 %}percentage-high{% elif percentage > 10 %}percentage-medium{% else %}percentage-low{% endif %}">
                            {{ "%.1f"|format(percentage) }}%
                        </span>
                    </td>
                    <td>
                        {% set percentage = row[3] or 0 %}
                        <span class="status-indicator {% if percentage > 20 %}status-error{% elif percentage > 10 %}status-warning{% else %}status-online{% endif %}"></span>
                        {% if percentage > 20 %}High{% elif percentage > 10 %}Medium{% else %}Normal{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Posts Distribution -->
    <div class="card">
        <h3>üìà Daily Posts Distribution</h3>
        <table class="distribution-table">
            <thead>
                <tr>
                    <th>Posts Today</th>
                    <th>Number of Users</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
                {% set total_users = posts_distribution|sum(attribute=1) %}
                {% for row in posts_distribution %}
                <tr>
                    <td>{{ row[0] }}</td>
                    <td>{{ row[1] }}</td>
                    <td>{{ "%.1f"|format((row[1] * 100.0 / total_users) if total_users > 0 else 0) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Admin Testing Tools -->
    <div class="test-section">
        <h3>üß™ Testing & Debugging Tools</h3>

        <div style="margin-bottom: 20px;">
            <h4>Test User Summary</h4>
            <input type="number" id="testUserId" placeholder="User ID" class="test-input">
            <button onclick="testUserSummary()" class="admin-btn">Test User</button>
            <button onclick="testDailyReset()" class="admin-btn">Test Daily Reset</button>
        </div>

        <div id="testResults" style="display: none;">
            <h4>Test Results</h4>
            <pre id="testOutput" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap;"></pre>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateLastRefreshTime();
});

function updateLastRefreshTime() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

async function refreshStats() {
    const btn = document.getElementById('refreshBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Refreshing...';

    try {
        const response = await fetch('/api/admin/maintenance/refresh-stats', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (data.success) {
            showToast('Statistics refreshed successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error refreshing stats: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üìä Refresh Stats';
    }
}

async function vacuumTables() {
    if (!confirm('This will vacuum and analyze community tables. Continue?')) return;

    const btn = document.getElementById('vacuumBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Vacuuming...';

    try {
        const response = await fetch('/api/admin/maintenance/vacuum', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        if (data.success) {
            showToast('Tables vacuumed successfully', 'success');
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error vacuuming tables: ' + error.message, 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üßπ Vacuum Tables';
    }
}

async function loadHealthData() {
    try {
        const response = await fetch('/api/admin/community/health');
        const data = await response.json();

        if (data.success) {
            // Update health metrics
            updateHealthGrid(data.health);
            updateLastRefreshTime();
            showToast('Dashboard refreshed', 'success');
        } else {
            showToast('Error loading health data: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error loading dashboard: ' + error.message, 'error');
    }
}

function updateHealthGrid(healthData) {
    const grid = document.getElementById('healthGrid');
    grid.innerHTML = '';

    healthData.forEach(metric => {
        const div = document.createElement('div');
        div.className = 'health-metric';
        div.innerHTML = `
            <div class="metric-value">${metric.value}</div>
            <div class="metric-label">${metric.metric.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
            <div class="metric-description">${metric.description}</div>
        `;
        grid.appendChild(div);
    });
}

async function testUserSummary() {
    const userId = document.getElementById('testUserId').value;
    if (!userId) {
        showToast('Please enter a user ID', 'warning');
        return;
    }

    try {
        const response = await fetch(`/api/admin/community/test-user/${userId}`);
        const data = await response.json();

        displayTestResults(data);

        if (data.success) {
            showToast('User test completed', 'success');
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error testing user: ' + error.message, 'error');
    }
}

async function testDailyReset() {
    const userId = document.getElementById('testUserId').value;
    if (!userId) {
        showToast('Please enter a user ID', 'warning');
        return;
    }

    try {
        const response = await fetch(`/api/admin/reset/test-user/${userId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();
        displayTestResults(data);

        if (data.success) {
            showToast('Daily reset test completed', 'success');
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('Error testing daily reset: ' + error.message, 'error');
    }
}

function displayTestResults(data) {
    const resultsDiv = document.getElementById('testResults');
    const outputPre = document.getElementById('testOutput');

    outputPre.textContent = JSON.stringify(data, null, 2);
    resultsDiv.style.display = 'block';
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : type === 'warning' ? '#f59e0b' : '#3b82f6'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        max-width: 300px;
        word-wrap: break-word;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    toast.textContent = message;

    document.body.appendChild(toast);

    // Animate in
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 10);

    // Remove after 4 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 4000);
}
</script>
{% endblock %}